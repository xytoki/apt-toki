name: Update APT Repo
on:
  workflow_dispatch:
  
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          path: main

      - name: Install aptly
        run: |
          wget -qO - https://www.aptly.info/pubkey.txt | sudo apt-key add -
          echo deb http://repo.aptly.info/ squeeze main | sudo tee /etc/apt/sources.list.d/aptly.list
          sudo apt-get update
          sudo apt-get install aptly
          mkdir -p ./.aptly
          ln -s ~/.aptly ./main/.aptly
          
      - name: aptly db Folder
        uses: actions/cache@v3.0.4
        with:
          path: ~/.aptly
          key: aptly

      - name: create repo
        run: aptly repo create -distribution=deb -component=main apt-toki
        
      - name: clone appnode-deb
        uses: actions/checkout@v3
        with:
          repository: xytoki/appnode-deb
          ref: dist
          path: deb-appnode
      
      - name: add deb to repo
        run: |
          aptly repo add apt-toki deb-appnode/*.deb
          aptly repo show -with-packages aptly-release
          
      - name: push back
        run: |
          cd main
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git diff-index --quiet HEAD || git commit -m "generated"
          git push
